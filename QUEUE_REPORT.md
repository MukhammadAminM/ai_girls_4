# –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ —Å–∏—Å—Ç–µ–º–µ –æ—á–µ—Ä–µ–¥–µ–π

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ú–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–º–µ—Å—Ç–∞-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
4. [–¢–∏–ø—ã –∑–∞–¥–∞—á](#—Ç–∏–ø—ã-–∑–∞–¥–∞—á)
5. [–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫–∏-–¥–∞–Ω–Ω—ã—Ö)
6. [–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞](#–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è-–æ–±—Ä–∞–±–æ—Ç–∫–∞)
7. [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
8. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–æ—Ç–ª–∞–¥–∫–∞)

---

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ –æ—á–µ—Ä–µ–¥–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Redis** –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ API (Live3D, Replicate, –ª–æ–∫–∞–ª—å–Ω—ã–π API)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ AI —á–µ—Ä–µ–∑ Venice API
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –±–æ—Ç–∞ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤)
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Telegram Bot   ‚îÇ
‚îÇ  (main.py)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ enqueue_task()
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   QueueService  ‚îÇ
‚îÇ (queue_service) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ LPUSH –≤ Redis
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Redis Queues   ‚îÇ
‚îÇ  - generate_    ‚îÇ
‚îÇ    image        ‚îÇ
‚îÇ  - generate_    ‚îÇ
‚îÇ    reply        ‚îÇ
‚îÇ  - generate_    ‚îÇ
‚îÇ    image_prompt ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ BRPOP –∏–∑ Redis
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  QueueWorker    ‚îÇ
‚îÇ  (worker.py)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–¥–∞—á
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  External APIs  ‚îÇ
‚îÇ  - Live3D       ‚îÇ
‚îÇ  - Replicate    ‚îÇ
‚îÇ  - Venice AI    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`app/services/queue_service.py`** - –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—á–µ—Ä–µ–¥—è–º–∏ Redis
   - `QueueService` - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å
   - `QueueTask` - –º–æ–¥–µ–ª—å –∑–∞–¥–∞—á–∏
   - `TaskType` - —Ç–∏–ø—ã –∑–∞–¥–∞—á (Enum)
   - `TaskStatus` - —Å—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á (Enum)

2. **`app/workers/queue_worker.py`** - –í–æ—Ä–∫–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á
   - `QueueWorker` - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –≤–æ—Ä–∫–µ—Ä–∞
   - –ú–µ—Ç–æ–¥—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–¥–∞—á
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å —Å–µ–º–∞—Ñ–æ—Ä–∞–º–∏

3. **`app/bot/task_helpers.py`** - –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
   - `enqueue_image_generation()` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
   - `enqueue_reply_generation()` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
   - `enqueue_image_prompt_generation()` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞
   - `wait_for_task_result()` - –æ–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–¥–∞—á–∏
   - `send_image_from_task_result()` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

---

## –ú–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

#### a) –ö–æ–º–∞–Ω–¥–∞ `/generate` (—Å—Ç—Ä–æ–∫–∞ 430 –≤ `app/bot/handlers.py`)
```python
task_id = await enqueue_image_generation(
    user_id=message.from_user.id,
    prompt=prompt,
    girl_id=girl.id,
)
```

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/generate` —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞.

**–ü–æ—Ç–æ–∫:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí `/generate <—Ç–µ–∫—Å—Ç>`
2. –ë–æ—Ç ‚Üí `enqueue_image_generation()` ‚Üí Redis –æ—á–µ—Ä–µ–¥—å
3. –í–æ—Ä–∫–µ—Ä ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á—É ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
4. –ë–æ—Ç ‚Üí –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

#### b) –ö–Ω–æ–ø–∫–∞ "–ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ" (—Å—Ç—Ä–æ–∫–∞ 2153 –≤ `app/bot/handlers.py`)
```python
task_id = await enqueue_image_generation(
    user_id=callback.from_user.id,
    prompt=prompt,
    dialog_id=active_dialog_id,
    girl_id=girl.id,
    negative_prompt=settings.image_default_negative_prompt,
)
```

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "üì∑ –ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ" –≤ –¥–∏–∞–ª–æ–≥–µ.

**–ü–æ—Ç–æ–∫:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ"
2. –ë–æ—Ç ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –∞–ª–º–∞–∑–æ–≤ ‚Üí —Å–ø–∏—Å—ã–≤–∞–µ—Ç –∞–ª–º–∞–∑—ã
3. –ë–æ—Ç ‚Üí `enqueue_image_generation()` ‚Üí Redis –æ—á–µ—Ä–µ–¥—å
4. –í–æ—Ä–∫–µ—Ä ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á—É ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
5. –ë–æ—Ç ‚Üí –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ AI

#### –î–∏–∞–ª–æ–≥ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º (—Å—Ç—Ä–æ–∫–∞ 852 –≤ `app/bot/handlers.py`)
```python
task_id = await enqueue_reply_generation(
    user_id=message.from_user.id,
    system_prompt=girl.system_prompt,
    history=history_payload,
    dialog_id=active_dialog_id,
    user_message=message.text,
)
```

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º.

**–ü–æ—Ç–æ–∫:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ
2. –ë–æ—Ç ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å —ç–Ω–µ—Ä–≥–∏–∏ ‚Üí —Å–ø–∏—Å—ã–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é
3. –ë–æ—Ç ‚Üí `enqueue_reply_generation()` ‚Üí Redis –æ—á–µ—Ä–µ–¥—å
4. –í–æ—Ä–∫–µ—Ä ‚Üí –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á—É ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Venice API
5. –ë–æ—Ç ‚Üí –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## –¢–∏–ø—ã –∑–∞–¥–∞—á

### 1. `GENERATE_IMAGE` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–û—á–µ—Ä–µ–¥—å:** `ai_girls:queue:generate_image`

**–î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:**
```python
{
    "prompt": str,              # –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    "negative_prompt": str,     # –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    "dialog_id": int,          # ID –¥–∏–∞–ª–æ–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    "girl_id": int,            # ID –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
}
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `QueueWorker._process_single_image_task()`

**–ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
2. –í—ã–±–∏—Ä–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (Live3D / Replicate / –ª–æ–∫–∞–ª—å–Ω—ã–π API)
3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
4. –ö–æ–¥–∏—Ä—É–µ—Ç –≤ base64
5. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—á–µ—Ç—á–∏–∫ —Ñ–æ—Ç–æ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω `dialog_id`)
6. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Redis

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**
- `Live3DImageClient` (–µ—Å–ª–∏ `settings.use_live3d = True`)
- `ReplicateImageClient` (–µ—Å–ª–∏ `settings.use_replicate = True`)
- `ImageClient` (–ª–æ–∫–∞–ª—å–Ω—ã–π API, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
{
    "image_base64": str,        # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64
    "image_size": int,          # –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –±–∞–π—Ç–∞—Ö
    "dialog_id": int,           # ID –¥–∏–∞–ª–æ–≥–∞
    "girl_id": int,             # ID –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
}
```

---

### 2. `GENERATE_REPLY` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ AI

**–û—á–µ—Ä–µ–¥—å:** `ai_girls:queue:generate_reply`

**–î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:**
```python
{
    "system_prompt": str,       # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    "history": list[dict],      # –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π [{"role": "user", "content": "..."}, ...]
    "dialog_id": int,          # ID –¥–∏–∞–ª–æ–≥–∞
    "user_message": str,       # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
}
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `QueueWorker._process_single_reply_task()`

**–ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Venice API
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ `chat_messages`)
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Redis

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**
- `VeniceClient` - –∫–ª–∏–µ–Ω—Ç –¥–ª—è Venice AI API

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
{
    "reply": str,               # –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    "dialog_id": int,          # ID –¥–∏–∞–ª–æ–≥–∞
}
```

---

### 3. `GENERATE_IMAGE_PROMPT` - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–û—á–µ—Ä–µ–¥—å:** `ai_girls:queue:generate_image_prompt`

**–î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:**
```python
{
    "girl_name": str,           # –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    "girl_description": str,     # –û–ø–∏—Å–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    "recent_dialogue": list[dict],  # –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
}
```

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫:** `QueueWorker._process_generate_image_prompt_tasks()`

**–ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç —á–µ—Ä–µ–∑ Venice API –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏–∞–ª–æ–≥–∞
3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Redis

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**
- `VeniceClient` - –∫–ª–∏–µ–Ω—Ç –¥–ª—è Venice AI API

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
{
    "prompt": str,              # –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —ç—Ç–æ—Ç —Ç–∏–ø –∑–∞–¥–∞—á–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ handlers, –Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

---

## –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ—Ç–æ–∫ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/generate`

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /generate <—Ç–µ–∫—Å—Ç>
   ‚Üì
2. handlers.py:handle_generate_image()
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –∞–ª–º–∞–∑–æ–≤
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç
   - –í—ã–∑—ã–≤–∞–µ—Ç enqueue_image_generation()
   ‚Üì
3. task_helpers.py:enqueue_image_generation()
   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É
   - –í—ã–∑—ã–≤–∞–µ—Ç queue_service.enqueue_task()
   ‚Üì
4. queue_service.py:enqueue_task()
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç UUID –¥–ª—è task_id
   - –°–æ–∑–¥–∞–µ—Ç QueueTask –æ–±—ä–µ–∫—Ç
   - LPUSH –≤ Redis: ai_girls:queue:generate_image
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–¥–∞—á—É –≤ Redis: ai_girls:result:{task_id}
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç task_id
   ‚Üì
5. handlers.py:wait_for_task_result()
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ (–∫–∞–∂–¥—ã–µ 0.2 —Å–µ–∫)
   - –û–∂–∏–¥–∞–µ—Ç TaskStatus.COMPLETED –∏–ª–∏ TaskStatus.FAILED
   ‚Üì
6. queue_worker.py:_process_single_image_task()
   - BRPOP –∏–∑ Redis: ai_girls:queue:generate_image
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ PROCESSING
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API
   - –ö–æ–¥–∏—Ä—É–µ—Ç –≤ base64
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ COMPLETED —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
   ‚Üì
7. handlers.py:wait_for_task_result()
   - –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   - –í—ã–∑—ã–≤–∞–µ—Ç send_image_from_task_result()
   ‚Üì
8. task_helpers.py:send_image_from_task_result()
   - –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç base64
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

### –ü–æ—Ç–æ–∫ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –≤ –¥–∏–∞–ª–æ–≥–µ

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –¥–∏–∞–ª–æ–≥–µ
   ‚Üì
2. handlers.py:handle_dialogue()
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å —ç–Ω–µ—Ä–≥–∏–∏
   - –°–ø–∏—Å—ã–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é
   - –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
   - –í—ã–∑—ã–≤–∞–µ—Ç enqueue_reply_generation()
   ‚Üì
3. task_helpers.py:enqueue_reply_generation()
   - –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É
   - –í—ã–∑—ã–≤–∞–µ—Ç queue_service.enqueue_task()
   ‚Üì
4. queue_service.py:enqueue_task()
   - LPUSH –≤ Redis: ai_girls:queue:generate_reply
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–¥–∞—á—É –≤ Redis
   ‚Üì
5. handlers.py:wait_for_task_result()
   - –û–∂–∏–¥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ç–∞–π–º–∞—É—Ç 60 —Å–µ–∫)
   ‚Üì
6. queue_worker.py:_process_single_reply_task()
   - BRPOP –∏–∑ Redis: ai_girls:queue:generate_reply
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ Venice API
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç –≤ –ë–î (chat_messages)
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ COMPLETED
   ‚Üì
7. handlers.py:handle_dialogue()
   - –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

---

## –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É** –∑–∞–¥–∞—á —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ —Å–µ–º–∞—Ñ–æ—Ä—ã:

```python
# –í QueueWorker.__init__()
self.image_semaphore = asyncio.Semaphore(
    settings.max_concurrent_image_generations  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5
)
self.reply_semaphore = asyncio.Semaphore(
    settings.max_concurrent_reply_generations  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10
)
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞—á:** –í–æ—Ä–∫–µ—Ä –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `asyncio.create_task()`
3. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:** –°–µ–º–∞—Ñ–æ—Ä –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
4. **–û–∂–∏–¥–∞–Ω–∏–µ:** –ï—Å–ª–∏ –ª–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç, –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∂–¥—É—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è —Å–ª–æ—Ç–∞

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞

–í `app/config.py`:
```python
max_concurrent_image_generations: int = 5   # –ú–∞–∫—Å–∏–º—É–º 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
max_concurrent_reply_generations: int = 10  # –ú–∞–∫—Å–∏–º—É–º 10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –æ—Ç–≤–µ—Ç–æ–≤
```

–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `.env`:
```env
MAX_CONCURRENT_IMAGE_GENERATIONS=10
MAX_CONCURRENT_REPLY_GENERATIONS=20
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–≥—É—Ç –ø–æ–ª—É—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ API –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è —Å–µ–º–∞—Ñ–æ—Ä–∞–º
- ‚úÖ –ó–∞–¥–∞—á–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤)

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Redis

–í `app/config.py`:
```python
redis_url: str = "redis://localhost:6379/0"
redis_queue_prefix: str = "ai_girls:queue:"
redis_result_prefix: str = "ai_girls:result:"
redis_result_ttl: int = 3600  # –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (1 —á–∞—Å)
```

–í `.env`:
```env
REDIS_URL=redis://localhost:6379/0
REDIS_QUEUE_PREFIX=ai_girls:queue:
REDIS_RESULT_PREFIX=ai_girls:result:
REDIS_RESULT_TTL=3600
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π Redis

**–û—á–µ—Ä–µ–¥–∏:**
- `ai_girls:queue:generate_image` - –æ—á–µ—Ä–µ–¥—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `ai_girls:queue:generate_reply` - –æ—á–µ—Ä–µ–¥—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
- `ai_girls:queue:generate_image_prompt` - –æ—á–µ—Ä–µ–¥—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- `ai_girls:result:{task_id}` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞—á–∏ (TTL: 1 —á–∞—Å)

### –°—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á

```python
class TaskStatus(str, Enum):
    PENDING = "pending"        # –ó–∞–¥–∞—á–∞ –≤ –æ—á–µ—Ä–µ–¥–∏
    PROCESSING = "processing"  # –ó–∞–¥–∞—á–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
    COMPLETED = "completed"    # –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
    FAILED = "failed"          # –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –æ—á–µ—Ä–µ–¥–∏

```python
from app.services.queue_service import QueueService, TaskType

queue_service = QueueService()
await queue_service.connect()

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
image_queue_length = await queue_service.get_queue_length(TaskType.GENERATE_IMAGE)
print(f"–ó–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {image_queue_length}")

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
reply_queue_length = await queue_service.get_queue_length(TaskType.GENERATE_REPLY)
print(f"–ó–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤: {reply_queue_length}")
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏

```python
from app.services.queue_service import QueueService

queue_service = QueueService()
await queue_service.connect()

task = await queue_service.get_task("task_id_here")
if task:
    print(f"–°—Ç–∞—Ç—É—Å: {task.status}")
    if task.status == TaskStatus.COMPLETED:
        print(f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {task.result}")
    elif task.status == TaskStatus.FAILED:
        print(f"–û—à–∏–±–∫–∞: {task.error}")
```

### –û—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏

```python
from app.services.queue_service import QueueService, TaskType

queue_service = QueueService()
await queue_service.connect()

# –û—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
await queue_service.clear_queue(TaskType.GENERATE_IMAGE)
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í–æ—Ä–∫–µ—Ä –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å
- –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á–∏
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á–∏
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ

**–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤:**
```
INFO - Queue worker started with 5 concurrent image generations and 10 concurrent reply generations
INFO - Processing image generation task: abc123-def456-...
INFO - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Live3D –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
INFO - Image generation completed: abc123-def456-...
ERROR - Error processing image generation task abc123-def456-...: Connection timeout
```

### –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–¥–∞—á–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–æ—Ä–∫–µ—Ä –∑–∞–ø—É—â–µ–Ω: `python worker.py`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis: `redis-cli ping`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö API (Live3D, Replicate, Venice)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–¥–∞—á–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–≤–µ–ª–∏—á—å—Ç–µ `MAX_CONCURRENT_IMAGE_GENERATIONS` –≤ `.env`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å Redis
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –≤–Ω–µ—à–Ω–∏—Ö API

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–¥–∞—á–∏ —Ç–µ—Ä—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `REDIS_RESULT_TTL` - –≤–æ–∑–º–æ–∂–Ω–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —É–¥–∞–ª—è—é—Ç—Å—è —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ
2. –£–≤–µ–ª–∏—á—å—Ç–µ —Ç–∞–π–º–∞—É—Ç –≤ `wait_for_task_result()`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏

---

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤

–î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–¥–∞—á –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤:

```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1
python worker.py

# –¢–µ—Ä–º–∏–Ω–∞–ª 2
python worker.py

# –¢–µ—Ä–º–∏–Ω–∞–ª 3
python worker.py
```

–ö–∞–∂–¥—ã–π –≤–æ—Ä–∫–µ—Ä –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –∏–∑ –æ–±—â–µ–π –æ—á–µ—Ä–µ–¥–∏ Redis. –°–µ–º–∞—Ñ–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç **–≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞**, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ 3 –≤–æ—Ä–∫–µ—Ä–æ–≤ —Å `MAX_CONCURRENT_IMAGE_GENERATIONS=5` –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–æ **15 –∑–∞–¥–∞—á –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**.

### –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
- –í—Å–µ –≤–æ—Ä–∫–µ—Ä—ã –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ –æ–¥–Ω–æ–º—É Redis
- –ó–∞–¥–∞—á–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## –†–µ–∑—é–º–µ

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

‚úÖ **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –±–æ—Ç –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏  
‚úÖ **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ  
‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤  
‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞** - –∫–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç  
‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ –∑–∞–¥–∞—á–∏  

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:**
   - –ö–æ–º–∞–Ω–¥–∞ `/generate` (—Å—Ç—Ä–æ–∫–∞ 430)
   - –ö–Ω–æ–ø–∫–∞ "–ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ" (—Å—Ç—Ä–æ–∫–∞ 2153)

2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤:**
   - –î–∏–∞–ª–æ–≥ —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º (—Å—Ç—Ä–æ–∫–∞ 852)

### –§–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã

- `app/services/queue_service.py` - —Å–µ—Ä–≤–∏—Å –æ—á–µ—Ä–µ–¥–µ–π
- `app/workers/queue_worker.py` - –≤–æ—Ä–∫–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `app/bot/task_helpers.py` - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `app/bot/handlers.py` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –±–æ—Ç–µ

