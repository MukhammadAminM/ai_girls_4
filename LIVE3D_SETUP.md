# Настройка Live3D API для генерации изображений

## Описание

Live3D API - это сервис для генерации изображений через API. Интеграция позволяет использовать Live3D вместо локального API или Replicate.

## Установка

Для обхода Cloudflare требуется установить зависимости:

```bash
pip install cloudscraper selenium
```

Также необходимо установить ChromeDriver:
- Скачайте с https://chromedriver.chromium.org/
- Или используйте `webdriver-manager`: `pip install webdriver-manager`

**Важно**: 
- Без `cloudscraper` и `selenium` запросы будут блокироваться Cloudflare (403 Forbidden)
- Selenium используется для выполнения запросов через браузер (как в test_live3d_api.py)
- Если Selenium недоступен, будет использован cloudscraper
- Если и cloudscraper недоступен, будет использован httpx (может не работать)

## Настройка

### 1. Получение токена

1. Зарегистрируйтесь на https://animegenius.live3d.io/
2. Получите Bearer токен из вашего аккаунта
3. Добавьте токен в `.env` файл:

```env
LIVE3D_API_TOKEN=your_bearer_token_here
```

### 2. Настройка параметров

Добавьте следующие переменные в `.env`:

```env
# Включить использование Live3D
USE_LIVE3D=true

# ID модели (по умолчанию 135)
LIVE3D_MODEL_ID=135

# Количество очков для одной генерации (по умолчанию 20)
LIVE3D_CONSUME_POINTS=20
```

### 3. Приоритет использования

Система проверяет настройки в следующем порядке:
1. `USE_LIVE3D=true` → используется Live3D
2. `USE_REPLICATE=true` → используется Replicate
3. Иначе → используется локальный API

## Параметры генерации

Live3D использует следующие параметры из настроек:

- `IMAGE_DEFAULT_WIDTH` - ширина изображения (по умолчанию 832)
- `IMAGE_DEFAULT_HEIGHT` - высота изображения (по умолчанию 1216)
- `IMAGE_DEFAULT_STEPS` - количество шагов (по умолчанию 28)
- `IMAGE_DEFAULT_CFG` - CFG scale (по умолчанию 5.0)
- `IMAGE_DEFAULT_SEED` - seed для генерации (по умолчанию -1 для случайного)
- `IMAGE_DEFAULT_NEGATIVE_PROMPT` - негативный промпт

## Особенности

1. **Асинхронная генерация**: Live3D работает асинхронно - сначала создается задача, затем периодически проверяется статус
2. **Автоматическое ожидание**: Клиент автоматически ждет завершения генерации (до 3 минут)
3. **Автоматическая конвертация**: Изображения автоматически конвертируются в PNG формат
4. **Автоматическое изменение размера**: Изображения автоматически изменяются до указанных размеров

## Пример использования

После настройки, генерация изображений будет автоматически использовать Live3D:

```python
# В queue_worker.py автоматически выбирается правильный клиент
if settings.use_live3d:
    image_client = Live3DImageClient()
    image_data = await image_client.generate_image(prompt)
```

## Отладка

Если возникают проблемы:

1. **403 Forbidden ошибка**: Убедитесь, что установлен `cloudscraper`:
   ```bash
   pip install cloudscraper
   ```

2. Проверьте токен в `.env` файле

3. Проверьте логи воркера - там будет видно, какой клиент используется:
   - "Используется cloudscraper для обхода Cloudflare" - правильно
   - "cloudscraper не установлен, используем httpx" - нужно установить cloudscraper

4. Убедитесь, что у вас достаточно очков на аккаунте Live3D

5. Проверьте, что модель с указанным ID существует

## Примечания

- Live3D защищен Cloudflare, поэтому требуется `cloudscraper` для обхода защиты
- Клиент автоматически использует `cloudscraper`, если он установлен, иначе использует `httpx` (может не работать)
- Генерация может занимать больше времени, чем локальный API или Replicate

