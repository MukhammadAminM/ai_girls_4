"""Сервис для определения уровня обнажения на основе диалога."""
import re
from typing import Sequence

from app.models import ChatMessage


# Ключевые слова для разных уровней обнажения
# УЛУЧШЕНО: Добавлено больше ключевых слов для лучшей детекции
PARTIAL_NUDITY_KEYWORDS = [
    "расстегнула блузку", "расстегнул блузку", "расстегиваю блузку", "расстегиваешь блузку",
    "расстегнула рубашку", "расстегнул рубашку", "расстегиваю рубашку", "расстегиваешь рубашку",
    "снимаю верх", "снимаю топ", "снимаю блузку", "снимаю рубашку", "снимаю майку",
    "сняла верх", "снял верх", "сняла топ", "снял топ", "сняла блузку", "снял блузку",
    "топлесс", "без верха", "без блузки", "без рубашки", "без майки",
    "сняла лифчик", "снял лифчик", "снимаю лифчик", "снимаешь лифчик",
    "сняла бюстгальтер", "снял бюстгальтер", "снимаю бюстгальтер", "снимаешь бюстгальтер",
    "без лифчика", "без бюстгальтера", "без бра",
    "грудь видна", "сиськи видны", "соски видны", "груди видны",
    "обнажила грудь", "показываю грудь", "грудь открыта",
    "без верха", "без одежды сверху", "верх снят",
]

FULL_NUDITY_KEYWORDS = [
    "полностью голая", "полностью голый", "полностью обнажен", "полностью обнажена",
    "совсем голая", "совсем голый", "совсем без одежды",
    "без трусов", "без нижнего белья", "без всего",
    "все сняла", "все снял", "все разделась", "все разделся",
    "голая", "голый", "обнажен", "обнажена", "обнажены",
    "ничего не надето", "ничего не одета",
    "пизда", "киска", "вагина", "клитор", "влагалище",
    "соски", "сосочки", "груди", "сиськи",
    "полностью раздета", "полностью раздет",
    "без одежды", "без всего", "голое тело",
    "показываю все", "все видно", "ничего не скрыто",
    "обнаженное тело", "голое тело", "тело без одежды",
    "попа", "попка", "зад", "задница",
    "член", "пенис", "яйца", "яички",
]

UNDRESSING_IN_PROGRESS_KEYWORDS = [
    "раздеваюсь", "раздеваешься", "раздевается",
    "снимаю платье", "снимаю юбку", "снимаю брюки", "снимаю штаны",
    "снимаю блузку", "снимаю рубашку", "снимаю майку", "снимаю топ",
    "расстегиваю блузку", "расстегиваю рубашку",
    "в процессе раздевания", "сейчас сниму",
    "начинаю раздеваться", "снимаю одежду", "раздеваю",
    "расстегиваю", "снимаю", "раздеваюсь",
]


def detect_nudity_level(messages: Sequence[ChatMessage], check_last: int = 6) -> str:
    """
    Определяет уровень обнажения на основе последних сообщений.
    
    Args:
        messages: Список сообщений диалога
        check_last: Количество последних сообщений для проверки
    
    Returns:
        "none" - нет обнажения
        "partial" - частичное обнажение (топлесс, без верха)
        "undressing" - в процессе раздевания
        "full" - полное обнажение
    """
    if not messages:
        return "none"
    
    # Берем последние N сообщений
    recent_messages = list(messages[-check_last:]) if len(messages) > check_last else list(messages)
    
    # Объединяем текст всех сообщений
    combined_text = " ".join([msg.content.lower() for msg in recent_messages])
    
    # Проверяем полное обнажение
    full_count = 0
    for keyword in FULL_NUDITY_KEYWORDS:
        pattern = r'\b' + re.escape(keyword.lower()) + r'\b'
        matches = len(re.findall(pattern, combined_text))
        full_count += matches
    
    # Проверяем частичное обнажение
    partial_count = 0
    for keyword in PARTIAL_NUDITY_KEYWORDS:
        pattern = r'\b' + re.escape(keyword.lower()) + r'\b'
        matches = len(re.findall(pattern, combined_text))
        partial_count += matches
    
    # Проверяем процесс раздевания
    undressing_count = 0
    for keyword in UNDRESSING_IN_PROGRESS_KEYWORDS:
        pattern = r'\b' + re.escape(keyword.lower()) + r'\b'
        matches = len(re.findall(pattern, combined_text))
        undressing_count += matches
    
    # Определяем уровень
    # Делаем детектор более чувствительным для лучшей синхронизации с диалогом
    if full_count >= 1:
        # Если есть хотя бы одно явное упоминание полного обнажения
        return "full"
    elif partial_count >= 1:
        # Достаточно 1 совпадения для частичного обнажения
        return "partial"
    elif undressing_count >= 1:
        # Достаточно 1 совпадения для процесса раздевания
        return "undressing"
    else:
        return "none"

